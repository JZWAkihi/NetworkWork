## 网络是怎样连接的



> 从浏览器中输入网址，到屏幕上显示出网页的内容，在这个只有几秒钟的过程中，很多硬件和软件都在各自的岗位上相互配合完成了一系列的工作。



网络的全貌

![网络的全貌](images\网络的全貌.png)



### 第一章、浏览器生成消息

#### 1.1、生成HTTP请求消息

##### 1.1.1、探索之旅从输入网址开始

```markdown
	在介绍浏览器的工作方式之前，让我们先来介绍一下网址。 网址，准确来说应该叫 URL。除了"http:",还有“ftp:”，"file:"，“mailto”等。

	浏览器不同的功能会用到不同的URL，比如访问Web服务器时用“http”，访问FTP服务器下载和上传文件时用"ftp"。

	不同的访问目标，URL的写法也会不同。例如在访问Web服务器和FTP服务器时，URL中包含服务器的域名和访问文件的路径名，而发邮箱的URL则包含收件人的邮件地址。此外，根据需要，URL中还会包含用户名、密码、服务器端口等信息。
```



 **Web服务器的URL**

![web服务器URL](images\web服务器URL.png)



**FTP服务器的URL**

![FTP服务器URL](images\FTP服务器URL.png)



**读取客户端计算机本地文件的URL**

![本地文件URL](images\本地文件URL.png)



**发送电子邮箱的URL**

![电子邮箱](images\电子邮箱.png)







```markdown
	URL开头的文字：即“http”，“file”，“ftp”，这部分文字都表示浏览器应当使用的访问方法。我们可以把这部分理解为访问时使用的协议类型。比如：HTTP协议，FTP协议。
```





##### 1.1.2、浏览器先要解析URL

```markdown
	浏览器要做的第一步工作就是对URL进行解析，从而**生成发送给Web服务器的请求消息。**

	我们首先对URL进行拆分。
```



![URL元素](images\URL元素.png)

```markdown
我们来举一个例子：

	对http://www.lab.glasscom.com/dir1/file1.html 进行拆分：

	Web服务区的全称时，www.lab.glasscom.com。

	文件路径：		/dir1/file1.html
						这个URL表示要访问www.lab.glasscom.com这个Web服务器上路径名为/dir1/file1.html的文件。
```



##### 1.1.3、省略文件名的情况

```markdown
我们来看一个不太一样的URL：

				http://www.lab.glasscom.com/dir1/

	这个URL是以 '/' 结尾的。我们可以这样理解，以'/' 结尾的 ‘ /dir/ ’后面本应该有的文件名被省略了。此时，服务器就会访问默认的文件。服务器会事先设置好要访问的默认文件名。这个设置根据服务器不同而不同。大多数情况下时index.html  或者 default.htm。
```





##### 1.1.4、HTTP的基本思路

```markdown
	解析完URL后，我们就知道应该要访问的目标在哪里了。
	
	接下来，浏览器会使用HTTP协议来访问Web服务器。
	HTTP协议定义了客户端和服务器之间交互的消息和步骤，其基本思路非常简单。
```



![HTTP的基本思路](images\HTTP的基本思路.png)

​		

- ```markdown
  首先：客户端会向服务器发送请求消息。
  
  	请求消息包含的内容时 “对什么” 和 “进行怎样的操作” 两个部分。
  
  	1. 其中“对什么”的部分相当于URI。一般来说，URI的内容是一个存放网页数据的文件名或者是一个CGI程序的文件名。也可以直接使		用“http”开头的URL来作为URI。
  
  	2. “进行怎样的操作”的部分称为方法。方法表示需要让Web服务器完成怎样的工作。比如，读取URI表示的数据、将客户端输入的数据		发送给URI表示的程序。
  
  		2.1 最常用的一个就是GET方法。访问的过程大概是这样的：在请求消息中写上GET方法，然后在URI中写上存放网页数据的文件		名，比如“/dir1/file1.html”，这就表示需要获取/dir1/file1.html文件中的数据。当Web服务器收到消息后，打开/dir1/file1.html		文件并读取里面的数据，然后将数据存放在响应消息中，并返回给客户端。
  
  		2.2 另一个常用的方法就是POST，我们在表单中填写数据并将其发送给Web服务器时会使用这个方法。使用POST方法时，在请求消	息中，除了URI和方法。还要加上传递给应用程序和脚本的数据，即用户在输入框中填写的信息。
  ```



![HTTP方法](images\HTTP方法.png)



- ```markdown
  收到请求消息之后，Web服务器会对其中的内容进行解析。
  	通过URI和方法来判断 “对什么” “进行什么样的操作 ” ，并根据这些要求完成自己的工作，然后将结果存放在响应消息中。
  
  	响应消息的开头有一个状态码，他表示执行的结果是成功还是错误。常见的状态码有200、404、500等。
  
  	状态码之后就是头字段和网页数据。
  ```





```markdow
响应消息会被发送回客户端，客户端收到之后，浏览器会从消息中读出所需的数据并显示在屏幕上。到这里，HTTP的整个工作就完成了。
```







##### 1.1.5、生成HTTP请求消息

```markdown
理解了HTTP的基本知识后，我们可以根据URL来生成HTTP请求消息。

	请求消息的第一行称为请求行。包含的信息有方法、URI、HTTP版本等。

  	选用哪一种方法主要取决于浏览器的工作状态。比如在地址栏输入网址，这里用GET方法，而表单提交会使用POST。

  	写好方法之后，加一个空格，然后写URI，URI的格式：/<目录名>/···/<文件名>

  	第一行末尾需要写上HTTP的版本号，这是为了表示该消息是基于哪个版本的HTTP规格编写的。
  
	第二行开始为消息头。消息头的功能就是用来存放这些信息。消息头的规格中定义了很多项目，如日期、客户端支持了数据类型、语言、压缩格式、客户端和服务器的软件名称和版本、数据有效期和最后更新的时间等。

	写完消息头之后，还需要添加一个完全没有内容的空行，然后写上需要发送的数据。这部分称为消息体。在使用GET方法时，消息体可以不需要写。而POST方法中需要写上表单数据。
```





##### 1.1.6、发送请求后会收到响应

```markdown
响应消息的格式以及基本思路和请求消息的格式时相同的。
差别只在第一行上。在响应消息中，第一行的内容为状态码和响应语句，用来表示请求的执行结果时成功还是出错。

	状态码是一个数字，它用来向程序员告知执行的结果。响应语句则是一段文字，用来向人们告知执行的结果。
	
	返回响应消息之后，浏览器会将数据提取出来并显示在屏幕上。我们就能看到网页的样子了。

	当网页中不仅仅有文字，还包含图片时，会在屏幕中留出用啦显示图片的空间。然后再次访问Web服务器，请求获取响应的图片并显示在预留的空间中。
	每条请求消息中只能写一个URI，所以每次只能获取一个文件。
```



![响应状态码](images\响应状态码.png)





```mark
下图来展示浏览器与Web服务器进行交互的整个过程：
```



![BS交互1](images\BS交互1.png)



![BS交互2](images\BS交互2.png)

![BS交互3](images\BS交互3.png)



![BS交互4](images\BS交互4.png)





#### 1.2、向DNS服务器查询Web服务器的IP地址

##### 1.2.1、IP地址的基本知识

```markdown
生成HTTP消息之后，接下来我们需要委托操作系统将消息发送给Web服务器。

	浏览器可以解析网址并生成HTTP请求，但它本身并不具备将消息发送到网络中的功能。但在此之前，我们需要查询网址中服务器域名对应的IP地址。

互联网和公司内部的局域网都是基于TCP/IP的思路来设计的。

	就是由一些小的子网，通过路由器连接起来一个大的网络。这里的子网可以理解为用集线器连接起来的几台计算器，我们将他看作一个单位，称为子网。将子网通过路由器连接起来，就形成了一个网络。

TCP/IP的结构如下图。
```



![TCPIP模型](images\TCPIP模型.png)



```markdown
**IP作用与OSI参考模型的网络层，在终端通信中作为唯一标识，便于确定数据的传递目标。**

	在网络中所有的设备都会分配一个地址。这个地址就相当于现实中某条路上的 “XX号XX室”。“号”对应的号码是分配给整个子网的，称为网络号。而“室”对应的号码是分配给子网中的计算机的，称为主机号。这个整体的地址就是IP地址。

	实际的IP地址是一串32比特的数字。按照8比特(1字节)为一组分成4组。分别用十进制表示，每一组的数字都是非负的整数范围在【0，255】，然后用圆点隔开。
```



![IP地址表示](images\IP地址表示.png)



```markdown
我们需要另外的附加信息表示IP地址的内部地址。比如哪部分是主机号、网络号？

	这一附加信息为称为**子网掩码。**

	子网掩码是由一台主机或路由器使用的分配位，用于确定如何从一台主机对应的IP地址中获得网络和子网的信息。简单来说，通过它可以确定一个IP地址的网络/子网部分的结束和主机部分的开始。

	子网掩码跟IP地址长度相等，其左边开始由一段连续的1组成，紧接着又是一段连续的0组成直到最后。比如 字样掩码： 255.255.255.0，这样写太长了，也可以写成 /24 ，两种写法含义完全一样。
```



![子网掩码](images\子网掩码.png)



```markdown
IP地址与子网掩码比较子网掩码为1的部分表示网络号，子网掩码为0的部分表示主机号。
```



![网络号主机号](images\网络号主机号.png)



```markdown
其中：IP地址的主机号全0，表示整个子网，全1表示向子网上所有设备发送包，即“广播”。
```





##### 1.2.2、域名和IP地址并用的理由

```markdown
TCP/IP网络是通过网络IP地址来确定通信对象的，因此不知道IP地址就无法将消息发送给对方？

	域名可以更加方便的记住服务器名称。

	如何用名称来完全代替IP地址，来确定通信对象时，就会使运行效率降低。IP地址只需要4个四个字节。而域名最短也要有几十个字节，增加了路由器的负担。
	
	因此：我们使用的方案是：
	人来使用域名，路由器使用IP地址。
	同时需要有一个机制，能够通过名称来查询IP地址，或者通过IP地址来查询名称。这个机制就是DNS。
```



##### 1.2.3、Socket库提供查询IP地址的功能

```markdown
1.DNS是如何查询到IP地址的?
	查询IP地址的方式就类似与HTTP的请求响应
	询问最近的DNS服务器： "https://www.baidu.com/" 的IP地址是什么。
	DNS就会回答说：该服务器的IP地址是"14.215.177.38"
	
	我们计算机上一定有相应的DNS客户端。而相当于客户端的部分称为DNS解析器，或简称解析器。
	通过DNS查询IP地址的操作称为域名解析。
	
2.什么是解析器?
	解析器实际上是一段程序，它包含在操作系统中的Socket库中。
    
3.什么是Socket库?
	库就是一堆通用程序组件的集合。Socket库包含的程序组件可以让其他的应用调用操作系统的网络功能，而解析器就是这个库中的其中一种程序组件。
	Socket库中包含了很多用于方式和接受数据的程序组件。
```



##### 1.2.4、通过解析器向DNS服务器发出查询

```markdown
1、解析器如何向DNS服务器发出查询
	Socket库中的程序都是标准组件，只需要从应用程序中调用就可以了。
```



```markdown
如下图：用C语言编写的网络应用程序的源代码示例：
我们写上解析器的程序名称为 "gethostbyname"，以及Web服务器的域名"www.lab.glasscom.com"
这样就完成了对解析器的调用。

只需要运行这一行程序，就完成前面所有这些工作。
	解析器回向DNS服务器发送查询消息。
	DNS会返回响应消息，包含查询到的IP地址。
	解析器回取出IP地址，并将其写入浏览器指定的内存地址中。
```



![解析器查询IP](images\解析器查询IP.png)



##### 1.2.5、解析器的内部原理

```markdown
1.解析器内部是如何工作的?
	浏览器调用解析器时，程序的控制流程就会转移到解析器的内部。
	解析器会生成要发送给DNS服务器的查询消息。这一过程时委托给操作系统内部的协议栈来执行的。
	解析器调用协议栈后，协议栈会执行发送消息的操作。
	然后通过网卡将消息发送给DNS服务器。
	
	IP地址被找到之后，将IP地址写入响应消息并返回给客户端。
	消息经过网络到达客户端，在经过协议栈被传递给解析器。
	然后解析器读取出消息，取出IP地址。并将IP地址传递给应用程序。
	实际上，解析器会将取出的IP地址写入应用程序指定的内存地址中。
```

![解析器内部](images\解析器内部.png)



```markdown
向DNS服务器发送消息时，我们也需要知道DNS服务器的IP地址。
只不过这个IP地址是作为TCP/IP的一个设置项目事先设置好的，不需要再去查询了。
```

​																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							

![DNSIP](images\DNSIP.png)















